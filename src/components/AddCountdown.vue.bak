<template>
  <view v-if="visible" class="modal-mask" @click="handleClose">
    <view class="modal-content" @click.stop>
      <view class="modal-header">
        <text class="modal-title">{{ countdownData ? '编辑倒数日' : '添加倒数日' }}</text>
        <view class="modal-close" @click="handleClose">
          <text class="close-icon">✕</text>
        </view>
      </view>

      <scroll-view scroll-y class="modal-body">
        <view class="form-item">
          <view class="form-label">日程名称</view>
          <input 
            class="form-input" 
            v-model="formData.title" 
            placeholder="请输入日程名称"
            maxlength="20"
          />
        </view>

        <view class="form-item">
          <view class="form-label">选择日期</view>
          <uni-datetime-picker
            type="date"
            v-model="formData.date"
            :clear-icon="false"
            @change="onDateChange"
            :border="false"
          >
            <view class="picker-input">
              <text v-if="formData.date" class="picker-text">{{ formatDateDisplay(formData.date) }}</text>
              <text v-else class="picker-placeholder">请选择日期</text>
            </view>
          </uni-datetime-picker>
        </view>

        <view class="form-item">
          <view class="form-label">选择分类</view>
          <view class="category-list">
            <view 
              v-for="category in categories" 
              :key="category.id"
              class="category-item"
              :class="{ 'category-active': formData.categoryId === category.id }"
              @click="selectCategory(category.id)"
            >
              <view class="category-icon" :style="{ backgroundColor: category.color }">
                <text class="icon-text">{{ category.icon }}</text>
              </view>
              <text class="category-name">{{ category.name }}</text>
            </view>
          </view>
        </view>

        <view class="form-item">
          <view class="form-label-row">
            <text class="form-label">置顶显示</text>
            <switch 
              :checked="formData.isPinned" 
              @change="onPinnedChange"
              color="#1890ff"
            />
          </view>
        </view>

        <view class="form-item">
          <view class="form-label">重复设置</view>
          <view class="repeat-selector">
            <picker-view 
              :value="[cycleIndex]" 
              @change="onCycleChange"
              class="cycle-picker-view"
            >
              <picker-view-column>
                <view v-for="(item, index) in cycleOptions" :key="index" class="picker-view-item">
                  <text>{{ item }}</text>
                </view>
              </picker-view-column>
            </picker-view>
            
            <picker-view 
              :value="[frequencyIndex]" 
              @change="onFrequencyChange"
              class="frequency-picker-view"
            >
              <picker-view-column>
                <view v-for="(item, index) in frequencyOptions" :key="index" class="picker-view-item">
                  <text>{{ item }}</text>
                </view>
              </picker-view-column>
            </picker-view>
          </view>
          <view class="repeat-hint">
            <text>当前设置：{{ getRepeatText() }}</text>
          </view>
        </view>
      </scroll-view>

      <view class="modal-footer">
        <view v-if="countdownData" class="btn btn-danger" @click="handleDelete">
          <text>删除/归档</text>
        </view>
        <view class="btn btn-ghost" @click="handleClose">
          <text>取消</text>
        </view>
        <view class="btn btn-primary" @click="handleSubmit">
          <text>确定</text>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
import db from '../utils/db.js';

export default {
  name: 'AddCountdown',
  props: {
    visible: {
      type: Boolean,
      default: false
    },
    countdownData: {
      type: Object,
      default: null
    }
  },
  data() {
    return {
      formData: {
        title: '',
        date: this.getCurrentDate(),
        categoryId: null,
        isPinned: false,
        repeatCycle: 0,
        repeatFrequency: '不重复'
      },
      categories: [],
      cycleOptions: ['不重复', '每1', '每2', '每3', '每4', '每5', '每6', '每7', '每8', '每9', '每10'],
      frequencyOptions: ['不重复', '天重复', '周重复', '月重复', '年重复'],
      cycleIndex: 0,
      frequencyIndex: 0
    };
  },
  watch: {
    visible(val) {
      if (val) {
        this.loadCategories();
        if (this.countdownData) {
          this.formData = {
            title: this.countdownData.title,
            date: this.countdownData.date,
            categoryId: this.countdownData.categoryId,
            isPinned: this.countdownData.isPinned || false,
            repeatCycle: this.countdownData.repeatCycle || 0,
            repeatFrequency: this.countdownData.repeatFrequency || '不重复'
          };
          this.syncRepeatIndexes();
        } else {
          this.resetForm();
        }
      }
    }
  },
  methods: {
    getCurrentDate() {
      const date = new Date();
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    },
    loadCategories() {
      const user = db.getCurrentUser();
      if (user) {
        this.categories = db.getCategories(user.id);
        if (this.categories.length > 0 && !this.formData.categoryId) {
          this.formData.categoryId = this.categories[0].id;
        }
      }
    },
    onDateChange(value) {
      this.formData.date = value;
    },
    selectCategory(categoryId) {
      this.formData.categoryId = categoryId;
    },
    onPinnedChange(e) {
      this.formData.isPinned = e.detail.value;
    },
    onCycleChange(e) {
      this.cycleIndex = e.detail.value[0];
      const cycleText = this.cycleOptions[this.cycleIndex];
      
      if (cycleText === '不重复') {
        this.frequencyIndex = 0;
        this.formData.repeatCycle = 0;
        this.formData.repeatFrequency = '不重复';
      } else {
        this.formData.repeatCycle = parseInt(cycleText.replace('每', ''));
        if (this.frequencyIndex === 0) {
          this.frequencyIndex = 1;
          this.formData.repeatFrequency = this.frequencyOptions[1];
        }
      }
    },
    onFrequencyChange(e) {
      this.frequencyIndex = e.detail.value[0];
      const frequencyText = this.frequencyOptions[this.frequencyIndex];
      
      if (frequencyText === '不重复') {
        this.cycleIndex = 0;
        this.formData.repeatCycle = 0;
        this.formData.repeatFrequency = '不重复';
      } else {
        this.formData.repeatFrequency = frequencyText;
        if (this.cycleIndex === 0) {
          this.cycleIndex = 1;
          this.formData.repeatCycle = 1;
        }
      }
    },
    syncRepeatIndexes() {
      if (this.formData.repeatCycle === 0 || this.formData.repeatFrequency === '不重复') {
        this.cycleIndex = 0;
        this.frequencyIndex = 0;
      } else {
        this.cycleIndex = this.cycleOptions.findIndex(opt => opt === `每${this.formData.repeatCycle}`);
        this.frequencyIndex = this.frequencyOptions.findIndex(opt => opt === this.formData.repeatFrequency);
        if (this.cycleIndex === -1) this.cycleIndex = 0;
        if (this.frequencyIndex === -1) this.frequencyIndex = 0;
      }
    },
    getRepeatText() {
      if (this.cycleIndex === 0 || this.frequencyIndex === 0) {
        return '不重复';
      }
      const cycle = this.cycleOptions[this.cycleIndex];
      const frequency = this.frequencyOptions[this.frequencyIndex];
      return `${cycle}${frequency}`;
    },
    formatDateDisplay(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
      const weekDay = weekDays[date.getDay()];
      return `${year}年${month}月${day}日 星期${weekDay}`;
    },
    handleClose() {
      this.$emit('close');
      this.resetForm();
    },
    handleDelete() {
      uni.showActionSheet({
        itemList: ['删除', '归档'],
        success: (res) => {
          if (res.tapIndex === 0) {
            uni.showModal({
              title: '确认删除',
              content: '确定要删除这个倒数日吗？',
              success: (modalRes) => {
                if (modalRes.confirm) {
                  try {
                    db.deleteCountdown(this.countdownData.id);
                    uni.showToast({
                      title: '删除成功',
                      icon: 'success'
                    });
                    this.$emit('success');
                    this.handleClose();
                  } catch (e) {
                    uni.showToast({
                      title: '删除失败',
                      icon: 'none'
                    });
                  }
                }
              }
            });
          } else if (res.tapIndex === 1) {
            uni.showModal({
              title: '确认归档',
              content: '确定要归档这个倒数日吗？归档后可在"我的"模块中查看。',
              confirmText: '归档',
              success: (modalRes) => {
                if (modalRes.confirm) {
                  try {
                    db.archiveCountdown(this.countdownData.id);
                    uni.showToast({
                      title: '归档成功',
                      icon: 'success'
                    });
                    this.$emit('success');
                    this.handleClose();
                  } catch (e) {
                    uni.showToast({
                      title: '归档失败',
                      icon: 'none'
                    });
                  }
                }
              }
            });
          }
        }
      });
    },
    handleSubmit() {
      if (!this.formData.title.trim()) {
        uni.showToast({
          title: '请输入日程名称',
          icon: 'none'
        });
        return;
      }

      if (!this.formData.date) {
        uni.showToast({
          title: '请选择日期',
          icon: 'none'
        });
        return;
      }

      if (!this.formData.categoryId) {
        uni.showToast({
          title: '请选择分类',
          icon: 'none'
        });
        return;
      }

      const user = db.getCurrentUser();
      if (!user) {
        uni.showToast({
          title: '用户信息获取失败',
          icon: 'none'
        });
        return;
      }

      try {
        if (this.countdownData) {
          db.updateCountdown(this.countdownData.id, {
            title: this.formData.title,
            date: this.formData.date,
            categoryId: this.formData.categoryId,
            isPinned: this.formData.isPinned,
            repeatCycle: this.formData.repeatCycle,
            repeatFrequency: this.formData.repeatFrequency
          });
          uni.showToast({
            title: '修改成功',
            icon: 'success'
          });
        } else {
          db.addCountdown({
            title: this.formData.title,
            date: this.formData.date,
            categoryId: this.formData.categoryId,
            userId: user.id,
            isPinned: this.formData.isPinned,
            repeatCycle: this.formData.repeatCycle,
            repeatFrequency: this.formData.repeatFrequency
          });
          uni.showToast({
            title: '添加成功',
            icon: 'success'
          });
        }
        this.$emit('success');
        this.handleClose();
      } catch (e) {
        uni.showToast({
          title: '操作失败',
          icon: 'none'
        });
      }
    },
    resetForm() {
      this.formData = {
        title: '',
        date: this.getCurrentDate(),
        categoryId: this.categories.length > 0 ? this.categories[0].id : null,
        isPinned: false,
        repeatCycle: 0,
        repeatFrequency: '不重复'
      };
      this.cycleIndex = 0;
      this.frequencyIndex = 0;
    }
  }
};
</script>

<style scoped>
.modal-mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-content {
  width: 640rpx;
  max-height: 90vh;
  background-color: #ffffff;
  border-radius: 20rpx;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 30rpx;
  border-bottom: 2rpx solid #e8f4ff;
  flex-shrink: 0;
}

.modal-title {
  font-size: 32rpx;
  font-weight: bold;
  color: #333333;
}

.modal-close {
  width: 60rpx;
  height: 60rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-icon {
  font-size: 40rpx;
  color: #666666;
}

.modal-body {
  flex: 1;
  padding: 30rpx;
  overflow-y: auto;
}

.form-item {
  margin-bottom: 40rpx;
}

.form-label {
  font-size: 28rpx;
  color: #333333;
  margin-bottom: 20rpx;
  font-weight: bold;
}

.form-label-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 28rpx;
  color: #333333;
  font-weight: bold;
}

.form-input {
  width: 100%;
  height: 80rpx;
  background-color: #f5f9ff;
  border: 2rpx solid #e8f4ff;
  border-radius: 12rpx;
  padding: 0 20rpx;
  font-size: 28rpx;
  color: #333333;
  box-sizing: border-box;
}

.picker-input {
  width: 100%;
  height: 80rpx;
  background-color: #f5f9ff;
  border: 2rpx solid #e8f4ff;
  border-radius: 12rpx;
  padding: 0 20rpx;
  display: flex;
  align-items: center;
  box-sizing: border-box;
}

.picker-text {
  font-size: 28rpx;
  color: #333333;
}

.picker-placeholder {
  font-size: 28rpx;
  color: #aaaaaa;
}

.category-list {
  display: flex;
  flex-wrap: wrap;
  gap: 20rpx;
}

.category-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20rpx;
  background-color: #f5f9ff;
  border: 2rpx solid #e8f4ff;
  border-radius: 12rpx;
  transition: all 0.3s;
  min-width: 120rpx;
}

.category-active {
  border-color: #1890ff;
  background-color: #e8f4ff;
}

.category-icon {
  width: 60rpx;
  height: 60rpx;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 10rpx;
}

.icon-text {
  font-size: 32rpx;
}

.category-name {
  font-size: 24rpx;
  color: #333333;
}

.repeat-selector {
  display: flex;
  gap: 20rpx;
}

.cycle-picker-view,
.frequency-picker-view {
  flex: 1;
  height: 200rpx;
  background-color: #f5f9ff;
  border: 2rpx solid #e8f4ff;
  border-radius: 12rpx;
}

.picker-view-item {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 80rpx;
  font-size: 28rpx;
  color: #333333;
}

.repeat-hint {
  margin-top: 16rpx;
  padding: 16rpx;
  background-color: #e8f4ff;
  border-radius: 8rpx;
  font-size: 24rpx;
  color: #1890ff;
  text-align: center;
}

.modal-footer {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 30rpx;
  border-top: 2rpx solid #e8f4ff;
  gap: 20rpx;
  flex-shrink: 0;
}

.btn {
  height: 80rpx;
  padding: 0 30rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12rpx;
  font-size: 28rpx;
}

.btn-ghost {
  background-color: transparent;
  border: 2rpx solid #1890ff;
  color: #1890ff;
}

.btn-primary {
  background-color: #1890ff;
  color: #ffffff;
}

.btn-danger {
  background-color: #e54d42;
  color: #ffffff;
}

/* 修复uni-input高度问题 */
uni-input {
  height: auto !important;
  min-height: 0 !important;
  line-height: normal !important;
}

/* 确保picker组件在最上层 */
picker,
picker-view {
  position: relative;
  z-index: 10000 !important;
}
</style>